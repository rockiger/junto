import { getEventRange, getEventTransfer } from 'slate-react'

import InsertImages from 'slate-drop-or-paste-images'

import ImageNode from './ImageNode'

/**
 * On drop, insert the image wherever it is dropped.
 *
 * @param {Event} event
 * @param {Change} change
 * @param {Editor} editor
 */

const onImageDrop = (event, change, editor) => {
    const target = getEventRange(event, change.value)
    if (!target && event.type == 'drop') return

    const transfer = getEventTransfer(event)
    const { type, text, files } = transfer

    if (type == 'files') {
        for (const file of files) {
            const reader = new FileReader()
            const [mime] = file.type.split('/')
            if (mime != 'image') continue

            reader.addEventListener('load', () => {
                editor.change(c => {
                    c.call(insertImage, reader.result, target)
                })
            })

            reader.readAsDataURL(file)
        }
    }

    if (type == 'text') {
        if (!isUrl(text)) return
        if (!isImage(text)) return
        change.call(insertImage, text, target)
    }
}

const ImageDndPlugin = InsertImages({
    extensions: ['png', 'jpeg', 'jpg', 'gif', 'bmp', 'svg'],
    insertImage: (transform, file) => {
        console.log('file:', file)
        return transform.insertBlock({
            type: 'image',
            isVoid: true,
            data: { file },
        })
    },
})

export { ImageDndPlugin, ImageNode, onImageDrop }
